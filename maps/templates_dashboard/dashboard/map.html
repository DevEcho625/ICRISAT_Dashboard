<!DOCTYPE html>
<html>
<head>
    <title>ICRISAT Field Map</title>
    <meta charset="utf-8" />

    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        #info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 14px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.25);
            width: 280px;
            z-index: 1000;
            font-size: 14px;
        }

        #info h3 {
            margin-top: 0;
        }

        .label {
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="info">
    <h3>Field Info</h3>
    <p>Click a field</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Initialize map
    var map = L.map('map').setView([17.506988, 78.275083], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Load GeoJSON fields
    fetch("/dashboard/fields/")
        .then(response => response.json())
        .then(geojsonData => {

            var fieldLayer = L.geoJSON(geojsonData, {
                style: {
                    color: "black",
                    weight: 1.5,
                    fillColor: "#00cfff",
                    fillOpacity: 0.5
                },

                onEachFeature: function (feature, layer) {
    const fieldNo = feature.properties.Field_no_j;

    layer.on("click", function () {

        document.getElementById("info").innerHTML = `
            <h3>Field ${fieldNo}</h3>
            <p>Loading dataâ€¦</p>
        `;

        // IMPORTANT: encode spaces + hyphens
        const encodedFieldNo = encodeURIComponent(fieldNo);

        fetch(`/dashboard/field-details/${encodedFieldNo}/`)
            .then(res => res.json())
            .then(data => {

                if (data.error) {
                    document.getElementById("info").innerHTML = `
                        <h3>Field ${fieldNo}</h3>
                        <p>No spreadsheet data found</p>
                    `;
                    return;
                }

                document.getElementById("info").innerHTML = `
                    <h3>Field ${data.FIELDNO}</h3>

                    <div><span class="label">REQ No:</span> ${data.REQNO}</div>
                    <div><span class="label">Date PTD:</span> ${data.DATEPTD}</div>
                    <div><span class="label">Plant Date:</span> ${data.PLANTDATE}</div>
                    <div><span class="label">Harvest Date:</span> ${data.HARVESTDAT}</div>
                    <div><span class="label">Actual Planting:</span> ${data.ACTUALPDAT}</div>
                    <div><span class="label">Experiment:</span> ${data.EXPDETAIL}</div>
                    <div><span class="label">Pest:</span> ${data.PESTNAME}</div>
                    <div><span class="label">Herbicide:</span> ${data.HERBNAME}</div>
		    <div><span class="label">Area Required:</span> ${data.AREAREQ}</div>
                `;
            })
            .catch(err => {
                console.error(err);
                document.getElementById("info").innerHTML = `
                    <h3>Field ${fieldNo}</h3>
                    <p>Error loading spreadsheet data</p>
                `;
            });
    });
}

            }).addTo(map);

            map.fitBounds(fieldLayer.getBounds());
        })
        .catch(err => {
            console.error("Failed to load GeoJSON:", err);
        });
</script>

</body>
</html>
